<!DOCTYPE html>
<html>
<head>
	<title>simple cms</title>
	<style type="text/css">.json > a { display: block; } </style>
</head>
<body>

	<section>
		<h1>photos</h1>
		<div class="json" data-endpoint='/photo'></div>
		<form action="/photo" method="post" enctype="multipart/form-data">
			<label>Select photo:</label>
			<input type="file" name="photos" multiple>
			<input type="submit" name="submit" value="Upload">
		</form>
	</section>

	<section>
		<h1>galleries</h1>
		<div class="json" data-endpoint='/gallery'></div>
		<label>Add to gallery:</label>
		<form id="gallery">
			<input type="text" name="uuid" placeholder="3">
			<input type="text" name="name" placeholder="name">
		</form>
		<button id='add-to-gallery'>Add</button>
	</section>

	<script type="text/javascript">
		window.addEventListener('load', init, false)

		function autoloadGallery(div) {
			var gallery = div.dataset.gallery

			function addPhoto(uuid) {
				var link = document.createElement('a')
				link.href = '/photo/' + uuid

				var img = document.createElement('img')
				img.src = '/photo/' + uuid + '/thumbnail'

				link.appendChild(img)
				div.appendChild(link)
			}

			fetch('/gallery/' + gallery)
				.then(response => response.json())
				.then(gallery => {
					div.appendChild(document.createTextNode(gallery.name))
					for (var photo of gallery.photos)
						addPhoto(photo)
				})
		}

		function load(div) {
			var endpoint = div.dataset.endpoint

			fetch(endpoint)
				.then(response => response.json())
				.then(data => {
					console.log(data)
					var entries = data.data || []
					for (var entry of entries) {
						var link = document.createElement('a')
						link.href = endpoint + '/' + entry
						link.appendChild(document.createTextNode(entry))
						div.appendChild(link)
					}
				})
		}

		function addToGallery(evt) {
			var fields = document.querySelectorAll('#gallery > input')
			var form = {}

			for (var i = 0; i < fields.length; i++) {
				var field = fields[i]
				form[field.name] = field.value
			}

			fetch('/gallery/' + form.name, {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify({ photos: [form.uuid] })
			}).then(clear).then(autoload).then(_ => {
				fields[0].value = ''
				fields[1].value = ''
			})
		}

		function clear() {
			var divs = document.querySelectorAll('[data-endpoint]')
			for (var div of divs)
				while (div.lastChild)
					div.removeChild(div.lastChild)
		}

		function autoload() {
			var divs = document.querySelectorAll('[data-endpoint]')
			for (var div of divs)
				load(div)

			var galleries = document.querySelectorAll('[data-gallery]')

			for (var gallery of galleries)
				autoloadGallery(gallery)
		}

		function init() {
			autoload()

			document.getElementById('add-to-gallery')
				.addEventListener('click', addToGallery, false)
		}

	</script>

</body>
</html>